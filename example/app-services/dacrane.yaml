name: quick-start
modules:
- name: image
  module: api-image
  argument:
    tag: latest
- name: container
  module: local-docker
  argument: ${{ modules.image.modules.api-local-image }}
---
name: local-docker
parameter:
  type: object
  required: ["image", "tag"]
  properties:
    image: { type: string }
    tag: { type: string }
modules:
- module: resource/docker-container
  name: docker
  argument:
    name: api
    image: ${{ parameter.image }}
    tag: ${{ parameter.tag }}
    port: 3000:3000
    env:
      - name: PORT
        value: "3000"
---
name: api-image
parameter:
  type: object
  required: ["tag"]
  properties:
    tag: { type: string }
    remote:
      type: object
      required: ["url", "user", "password"]
      properties:
        url: { type: string }
        user: { type: string }
        password: { type: string }
dependencies:
- name: base
  module: base
modules:
- name: api-local-image
  module: resource/docker-local-image
  argument:
    dockerfile: ./Dockerfile
    image: sample-api
    tag: ${{ parameter.tag }}
- name: api-remote-image
  if: ${{ parameter.remote != null }}
  module: resource/docker-remote-image
  argument:
    image: ${{ modules.api-local-image.image }}
    tag: ${{ modules.api-local-image.tag }}
    remote: ${{ parameter.remote }}
---
name: "app-service"
argument:
parameter:
  type: object
  required: ["env", "spec"]
  properties:
    env: { type: string }
    spec: { type: string, enum: ["low", "high"] }
dependencies:
- name: base
  module: base
- name: api
  module: api-image
modules:
- name: credentials
  module: azure_credentials
- name: asp
  module: resource/azure-app-service-plan
  argument:
    name: ${{ parameter.env }}-${{ dependencies.base.parameter.prefix }}-sample-asp
    resource_group_name: ${{ dependencies.base.modules.rg.name }}
    location: "Japan East"
    kind: "Linux"
    sku:
      tier: '${{ {"low": "Basic", "high": "Standard" }[parameter.spec] }}'
      name: '${{ {"low": "B1", "high": "S1" }[parameter.spec] }}'
    credentials: ${{ modules.credentials.credentials }}
- name: as
  module: resource/azure-app-service
  argument:
    name: ${{ parameter.env }}-${{ dependencies.base.parameter.prefix }}-sample-as
    resource_group_name: ${{ dependencies.base.modules.rg.name }}
    location: "Japan East"
    app_service_plan_id: ${{ modules.asp.name }}
    site_config:
      linux_fx_version: DOCKER|${{ dependencies.base.modules.acr.url }}/sample-api:${{ dependencies.api.modules.api-remote-image.tag }}
    app_settings:
      DOCKER_REGISTRY_SERVER_URL: ${{ dependencies.base.modules.acr.url }}
      DOCKER_REGISTRY_SERVER_USERNAME: ${{ dependencies.base.modules.acr.user }}
      DOCKER_REGISTRY_SERVER_PASSWORD: ${{ dependencies.base.modules.acr.password }}
      WEBSITES_PORT: "3000"
    credentials: ${{ modules.credentials.credentials }}
---
name: base
parameter:
  type: object
  required: ["prefix"]
  properties:
    prefix: { type: string }
modules:
- name: credentials
  module: azure_credentials
- name: rg
  module: resource/azure-resource-group
  argument:
    name: ${{ parameter.prefix }}-sample-rg
    location: "Japan East"
    credentials: ${{ modules.credentials.credentials }}
- name: acr
  module: resource/azure-container-registry
  argument:
    name: ${{ parameter.prefix }}sampleacr
    resource_group_name: ${{ modules.rg.name }}
    location: "Japan East"
    credentials: ${{ modules.credentials.credentials }}
---
name: azure_credentials
modules:
- name: credentials
  module: data/environment
  argument:
    subscription_id: AZURE_SUBSCRIPTION_ID
    tenant_id: AZURE_TENANT_ID
    client_id: AZURE_CLIENT_ID
    username: AZURE_USERNANE
    password: AZURE_PASSWORD

kind: artifact
name: api
provider: docker
parameters:
  image: sample-api
  tag: ${{ arg.tag >> "latest" }} # increase attribute
  dockerfile: ./Dockerfile
  remote:
    if: ${{ config.service == "app-service" }}
    url: ${{ resource.acr.url }}
    user: ${{ resource.acr.user }}
    password: ${{ resource.acr.password }}
---
if: ${{ config.service == "app-service" }}
kind: resource
name: acr
provider: azure-container-registry
parameters:
  name: sampledacraneacr
  resource_group_name: ${{ resource.rg.name }}
  location: "Japan East"
  credentials: ${{ data.azure_credential }}
---
if: ${{ config.service == "app-service" }}
kind: resource
name: rg
provider: azure-resource-group
parameters:
  name: sample-rg
  location: "Japan East"
  credentials: ${{ data.azure_credential }}
---
if: ${{ config.service == "app-service" }}
kind: resource
name: asp
provider: azure-app-service-plan
parameters:
  name: sample-asp
  resource_group_name: ${{ resource.rg.name }}
  location: "Japan East"
  kind: "Linux"
  sku:
    tier: '${{ {"low": "Basic", "high": "Premium" }[config.spec] }}'
    name: '${{ {"low": "B1", "high": "P1" }[config.spec] }}'
  credentials: ${{ data.azure_credential }}
---
if: ${{ config.service == "app-service" }}
kind: resource
name: as
provider: azure-app-service
parameters:
  name: sample-as
  resource_group_name: sample-rg
  location: "Japan East"
  app_service_plan_id: ${{ resource.asp.name }}
  site_config:
    linux_fx_version: DOCKER|${{ resource.acr.url }}/sample-api:${{ artifact.api.tag }}
  app_settings:
    DOCKER_REGISTRY_SERVER_URL: ${{ resource.acr.url }}
    DOCKER_REGISTRY_SERVER_USERNAME: ${{ resource.acr.user }}
    DOCKER_REGISTRY_SERVER_PASSWORD: ${{ resource.acr.password }}
    WEBSITES_PORT: "3000"
  credentials: ${{ data.azure_credential }}
---
if: ${{ config.service == "local-docker" }}
kind: resource
name: docker
provider: docker
parameters:
  name: api
  image: ${{ artifact.api.image }}
  tag: ${{ arg.tag >> "latest" }}
  port: 3000:3000
  env:
    - name: PORT
      value: "3000"
---
kind: data
name: azure_credential
provider: environment
parameters:
  subscription_id: AZURE_SUBSCRIPTION_ID
  tenant_id: AZURE_TENANT_ID
  client_id: AZURE_CLIENT_ID
  username: AZURE_USERNANE
  password: AZURE_PASSWORD
